<!DOCTYPE html> <html lang="en"> <head> <meta http-equiv="Content-Type" content="text/html; charset=UTF-8"> <meta charset="utf-8"> <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"> <meta http-equiv="X-UA-Compatible" content="IE=edge"> <title> Some Notes about Linux LSM | Jinmeng Zhou </title> <meta name="author" content="Jinmeng Zhou"> <meta name="description" content="Kernel version is v4.18.5."> <meta name="keywords" content="jekyll, jekyll-theme, academic-website, portfolio-website"> <link rel="stylesheet" href="/assets/css/bootstrap.min.css?a4b3f509e79c54a512b890d73235ef04"> <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/mdbootstrap@4.20.0/css/mdb.min.css" integrity="sha256-jpjYvU3G3N6nrrBwXJoVEYI/0zw8htfFnhT9ljN3JJw=" crossorigin="anonymous"> <link defer rel="stylesheet" href="/assets/css/academicons.min.css?f0b7046b84e425c55f3463ac249818f5"> <link defer rel="stylesheet" href="/assets/css/scholar-icons.css?62b2ac103a88034e6882a5be5f3e2772"> <link defer rel="stylesheet" type="text/css" href="https://fonts.googleapis.com/css?family=Roboto:300,400,500,700|Roboto+Slab:100,300,400,500,700|Material+Icons&amp;display=swap"> <link defer rel="stylesheet" href="/assets/css/jekyll-pygments-themes-github.css?591dab5a4e56573bf4ef7fd332894c99" media="" id="highlight_theme_light"> <link rel="shortcut icon" href="data:image/svg+xml,&lt;svg%20xmlns=%22http://www.w3.org/2000/svg%22%20viewBox=%220%200%20100%20100%22&gt;&lt;text%20y=%22.9em%22%20font-size=%2290%22&gt;%E2%9A%9B%EF%B8%8F&lt;/text&gt;&lt;/svg&gt;"> <link rel="stylesheet" href="/assets/css/main.css?d41d8cd98f00b204e9800998ecf8427e"> <link rel="canonical" href="https://jeimon.github.io/blog/2019/linux-lsm/"> <script src="/assets/js/theme.js?a81d82887dd692e91686b43de4542f18"></script> <link defer rel="stylesheet" href="/assets/css/jekyll-pygments-themes-native.css?5847e5ed4a4568527aa6cfab446049ca" media="none" id="highlight_theme_dark"> <script>
    initTheme();
  </script> </head> <body class="fixed-top-nav "> <header> <nav id="navbar" class="navbar navbar-light navbar-expand-sm fixed-top" role="navigation"> <div class="container"> <a class="navbar-brand title font-weight-lighter" href="/"> <span class="font-weight-bold">Jinmeng</span> Zhou </a> <button class="navbar-toggler collapsed ml-auto" type="button" data-toggle="collapse" data-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation"> <span class="sr-only">Toggle navigation</span> <span class="icon-bar top-bar"></span> <span class="icon-bar middle-bar"></span> <span class="icon-bar bottom-bar"></span> </button> <div class="collapse navbar-collapse text-right" id="navbarNav"> <ul class="navbar-nav ml-auto flex-nowrap"> <li class="nav-item "> <a class="nav-link" href="/">about </a> </li> <li class="nav-item active"> <a class="nav-link" href="/blog/">blog </a> </li> <li class="nav-item "> <a class="nav-link" href="/publications/">publications </a> </li> <li class="nav-item "> <a class="nav-link" href="/projects/">projects </a> </li> <li class="nav-item "> <a class="nav-link" href="/cv/">cv </a> </li> <li class="nav-item"> <button id="search-toggle" title="Search" onclick="openSearchModal()"> <span class="nav-link">ctrl k <i class="ti ti-search"></i></span> </button> </li> <li class="toggle-container"> <button id="light-toggle" title="Change theme"> <i class="ti ti-sun-moon" id="light-toggle-system"></i> <i class="ti ti-moon-filled" id="light-toggle-dark"></i> <i class="ti ti-sun-filled" id="light-toggle-light"></i> </button> </li> </ul> </div> </div> </nav> <progress id="progress" value="0"> <div class="progress-container"> <span class="progress-bar"></span> </div> </progress> </header> <div class="container mt-5" role="main"> <div class="post"> <header class="post-header"> <h1 class="post-title">Some Notes about Linux LSM</h1> <p class="post-meta"> Created on November 08, 2019 </p> <p class="post-tags"> <a href="/blog/2019"> <i class="fa-solid fa-calendar fa-sm"></i> 2019 </a>   ·   <a href="/blog/tag/kernel"> <i class="fa-solid fa-hashtag fa-sm"></i> kernel</a>   <a href="/blog/tag/security"> <i class="fa-solid fa-hashtag fa-sm"></i> security</a>   ·   <a href="/blog/category/linux-kernel"> <i class="fa-solid fa-tag fa-sm"></i> linux-kernel</a> </p> </header> <article class="post-content"> <div id="markdown-content"> <h2 id="discretionary-access-control">Discretionary Access Control</h2> <p>Linux was initially developed as a clone of the Unix operating system in the early 1990s. As such, it inherits the core Unix security model—a form of Discretionary Access Control (DAC). The security features of the Linux kernel have evolved significantly to meet modern requirements, although Unix DAC remains as the core model.</p> <p>Briefly, Unix DAC allows the owner of an object (such as a file) to set the security policy for that object—which is why it’s called a discretionary scheme. As a user, you can, for example, create a new file in your home directory and decide who else may read or write the file. This policy is implemented as permission bits attached to the file’s inode, which may be set by the owner of the file. Permissions for accessing the file, such as read and write, may be set separately for the owner, a specific group, and other (i.e. everyone else). This is a relatively simple form of access control lists (ACLs).</p> <p>Programs launched by a user run with all of the rights of that user, whether they need them or not. There is also a superuser—an all-powerful entity which bypasses Unix DAC policy for the purpose of managing the system. Running a program as the superuser provides that program with all rights on the system.</p> <p>However DAC does not adequately protect against buggy or misconfigured software, for example, which may be exploited by an attacker seeking unauthorized access to resources. There are all kinds of Linux security extensions, we just dicuss the Linux Security Modules and we will take the SELinux as an example to see how it works. ( If you want to see more information about the overview of Linux kernel security features, <a href="https://www.linux.com/learn/overview-linux-kernel-security-features" rel="external nofollow noopener" target="_blank">click here</a>).</p> <h2 id="linux-security-modules">Linux Security Modules</h2> <p>The Linux Security Modules (LSM) API implements hooks at all security-critical points within the kernel. A user of the framework (an “LSM”) can register with the API and receive callbacks from these hooks. All security-relevant information is safely passed to the LSM, avoiding race conditions, and the LSM may deny the operation. This is similar to the Netfilter hook-based API, although applied to the general kernel.</p> <p>The LSM API allows different security models to be plugged into the kernel—typically access control frameworks, such as SELinux, AppArmor, Smack and so on. In other words, we have 190 security-critical check points whose implementations are customized by user. For each point, we can plug one or more check implementations (access control frameworks). To ensure compatibility with existing applications, the LSM hooks are placed so that the Unix DAC checks are performed first, and only if they succeed, is LSM code invoked.</p> <p>And all security hooks are initialized in security/security.c. We use one simple security-critical check point for example, <a href="https://elixir.bootlin.com/linux/v4.18.5/source/security/security.c#L887" rel="external nofollow noopener" target="_blank"><code class="language-plaintext highlighter-rouge">security_file_ioctl</code></a>, and figure out how it works:</p> <div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">int</span> <span class="nf">security_file_ioctl</span><span class="p">(</span><span class="k">struct</span> <span class="nc">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">cmd</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">call_int_hook</span><span class="p">(</span><span class="n">file_ioctl</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">file</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span> <span class="n">arg</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div></div> <p>It uses <a href="https://elixir.bootlin.com/linux/v4.18.5/source/security/security.c#L214" rel="external nofollow noopener" target="_blank"><code class="language-plaintext highlighter-rouge">call_int_hook</code></a> macro to initialize.</p> <div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">#define call_int_hook(FUNC, IRC, ...) ({			\  
</span>	<span class="kt">int</span> <span class="n">RC</span> <span class="o">=</span> <span class="n">IRC</span><span class="p">;</span>						\
	<span class="k">do</span> <span class="p">{</span>							\
		<span class="k">struct</span> <span class="nc">security_hook_list</span> <span class="o">*</span><span class="n">P</span><span class="p">;</span>			\
								\
		<span class="n">hlist_for_each_entry</span><span class="p">(</span><span class="n">P</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">security_hook_heads</span><span class="p">.</span><span class="n">FUNC</span><span class="p">,</span> <span class="n">list</span><span class="p">)</span> <span class="p">{</span> \
			<span class="n">RC</span> <span class="o">=</span> <span class="n">P</span><span class="o">-&gt;</span><span class="n">hook</span><span class="p">.</span><span class="n">FUNC</span><span class="p">(</span><span class="n">__VA_ARGS__</span><span class="p">);</span>		\
			<span class="k">if</span> <span class="p">(</span><span class="n">RC</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>				\
				<span class="k">break</span><span class="p">;</span>				\
		<span class="p">}</span>						\
	<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="mi">0</span><span class="p">);</span>						\
	<span class="n">RC</span><span class="p">;</span>							\
<span class="p">})</span>
</code></pre></div></div> <p>Then call_int_hook use hlist_for_each_entry ( a loop as following) macro to go through all the check implementations at the check point “security_hook_heads.FUNC”.</p> <p>Then <a href="https://elixir.bootlin.com/linux/v4.18.5/source/security/security.c#L214" rel="external nofollow noopener" target="_blank"><code class="language-plaintext highlighter-rouge">call_int_hook</code></a> use <a href="https://elixir.bootlin.com/linux/v4.18.5/source/include/linux/list.h#L754" rel="external nofollow noopener" target="_blank"><code class="language-plaintext highlighter-rouge">hlist_for_each_entry</code></a> (a loop as following) macro to go through all the check implementations at the check point “<a href="https://elixir.bootlin.com/linux/v4.18.5/source/include/linux/lsm_hooks.h#L1777" rel="external nofollow noopener" target="_blank"><code class="language-plaintext highlighter-rouge">security_hook_heads</code></a>.FUNC”.</p> <div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cm">/**
 * hlist_for_each_entry	- iterate over list of given type
 * @pos:	the type * to use as a loop cursor.
 * @head:	the head for your list.
 * @member:	the name of the hlist_node within the struct.
 */</span>
<span class="cp">#define hlist_for_each_entry(pos, head, member)				\
	for (pos = hlist_entry_safe((head)-&gt;first, typeof(*(pos)), member);\
	     pos;							\
	     pos = hlist_entry_safe((pos)-&gt;member.next, typeof(*(pos)), member))
</span><span class="k">struct</span> <span class="nc">security_hook_heads</span> <span class="p">{</span>
<span class="p">...</span>
	<span class="k">struct</span> <span class="nc">hlist_head</span> <span class="n">file_permission</span><span class="p">;</span>
	<span class="k">struct</span> <span class="nc">hlist_head</span> <span class="n">file_alloc_security</span><span class="p">;</span>
	<span class="k">struct</span> <span class="nc">hlist_head</span> <span class="n">file_free_security</span><span class="p">;</span>
	<span class="k">struct</span> <span class="nc">hlist_head</span> <span class="n">file_ioctl</span><span class="p">;</span>
	<span class="p">...</span>
<span class="p">}</span> <span class="n">__randomize_layout</span><span class="p">;</span>
</code></pre></div></div> <p>We can find <code class="language-plaintext highlighter-rouge">struct hlist_head file_ioctl</code> is inside the <code class="language-plaintext highlighter-rouge">security_hook_heads</code> which is indexed by <code class="language-plaintext highlighter-rouge">FUNC</code>. <a href="https://elixir.bootlin.com/linux/v4.18.5/source/include/linux/lsm_hooks.h#L1777" rel="external nofollow noopener" target="_blank"><code class="language-plaintext highlighter-rouge">security_hook_heads</code></a> is consisted of several <code class="language-plaintext highlighter-rouge">struct hlist_head</code> type variable which is a two-way linked-list data structure that links different kinds of check implements needed. It can be understood better by showing the figure as follow:</p> <div class="row mt-3"> <div class="col-sm mt-3 mt-md-0"> <figure> <picture> <source class="responsive-img-srcset" srcset="/assets/img/lsm-480.webp 480w,/assets/img/lsm-800.webp 800w,/assets/img/lsm-1400.webp 1400w," type="image/webp" sizes="95vw"></source> <img src="/assets/img/lsm.png" class="img-fluid rounded z-depth-1" width="100%" height="auto" loading="eager" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> </figure> </div> </div> <div class="caption"> Figure 1: assuming firstly do SELinux check, secondly do AppArmor check and then other checks. </div> <p>All the different access control frameworks use <code class="language-plaintext highlighter-rouge">LSM_HOOK_INIT</code> to add their check implementations, let us see how SELinux do it.</p> <div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">static</span> <span class="k">struct</span> <span class="nc">security_hook_list</span> <span class="n">selinux_hooks</span><span class="p">[]</span> <span class="n">__lsm_ro_after_init</span> <span class="o">=</span> <span class="p">{</span>
<span class="p">...</span>
	<span class="n">LSM_HOOK_INIT</span><span class="p">(</span><span class="n">file_permission</span><span class="p">,</span> <span class="n">selinux_file_permission</span><span class="p">),</span>
	<span class="n">LSM_HOOK_INIT</span><span class="p">(</span><span class="n">file_alloc_security</span><span class="p">,</span> <span class="n">selinux_file_alloc_security</span><span class="p">),</span>
	<span class="n">LSM_HOOK_INIT</span><span class="p">(</span><span class="n">file_ioctl</span><span class="p">,</span> <span class="n">selinux_file_ioctl</span><span class="p">),</span>
	<span class="p">...</span>
<span class="p">};</span>
</code></pre></div></div> </div> </article> </div> </div> <footer class="fixed-bottom" role="contentinfo"> <div class="container mt-0"> © Copyright 2025 Jinmeng Zhou. Powered by <a href="https://jekyllrb.com/" target="_blank" rel="external nofollow noopener">Jekyll</a> with <a href="https://github.com/alshedivat/al-folio" rel="external nofollow noopener" target="_blank">al-folio</a> theme. Hosted by <a href="https://pages.github.com/" target="_blank" rel="external nofollow noopener">GitHub Pages</a>. Photos from <a href="https://unsplash.com" target="_blank" rel="external nofollow noopener">Unsplash</a>. </div> </footer> <script src="https://cdn.jsdelivr.net/npm/jquery@3.6.0/dist/jquery.min.js" integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4=" crossorigin="anonymous"></script> <script src="/assets/js/bootstrap.bundle.min.js"></script> <script src="https://cdn.jsdelivr.net/npm/mdbootstrap@4.20.0/js/mdb.min.js" integrity="sha256-NdbiivsvWt7VYCt6hYNT3h/th9vSTL4EDWeGs5SN3DA=" crossorigin="anonymous"></script> <script defer src="https://cdn.jsdelivr.net/npm/masonry-layout@4.2.2/dist/masonry.pkgd.min.js" integrity="sha256-Nn1q/fx0H7SNLZMQ5Hw5JLaTRZp0yILA/FRexe19VdI=" crossorigin="anonymous"></script> <script defer src="https://cdn.jsdelivr.net/npm/imagesloaded@5.0.0/imagesloaded.pkgd.min.js" integrity="sha256-htrLFfZJ6v5udOG+3kNLINIKh2gvoKqwEhHYfTTMICc=" crossorigin="anonymous"></script> <script defer src="/assets/js/masonry.js?a0db7e5d5c70cc3252b3138b0c91dcaf" type="text/javascript"></script> <script defer src="https://cdn.jsdelivr.net/npm/medium-zoom@1.1.0/dist/medium-zoom.min.js" integrity="sha256-ZgMyDAIYDYGxbcpJcfUnYwNevG/xi9OHKaR/8GK+jWc=" crossorigin="anonymous"></script> <script defer src="/assets/js/zoom.js?85ddb88934d28b74e78031fd54cf8308"></script> <script src="/assets/js/no_defer.js?2781658a0a2b13ed609542042a859126"></script> <script defer src="/assets/js/common.js?e0514a05c5c95ac1a93a8dfd5249b92e"></script> <script defer src="/assets/js/copy_code.js?c8a01c11a92744d44b093fc3bda915df" type="text/javascript"></script> <script defer src="/assets/js/jupyter_new_tab.js?d9f17b6adc2311cbabd747f4538bb15f"></script> <script async src="https://d1bxh8uas1mnw7.cloudfront.net/assets/embed.js"></script> <script async src="https://badge.dimensions.ai/badge.js"></script> <script defer type="text/javascript" id="MathJax-script" src="https://cdn.jsdelivr.net/npm/mathjax@3.2.2/es5/tex-mml-chtml.js" integrity="sha256-MASABpB4tYktI2Oitl4t+78w/lyA+D7b/s9GEP0JOGI=" crossorigin="anonymous"></script> <script src="/assets/js/mathjax-setup.js?a5bb4e6a542c546dd929b24b8b236dfd"></script> <script defer src="https://cdnjs.cloudflare.com/polyfill/v3/polyfill.min.js?features=es6" crossorigin="anonymous"></script> <script defer src="/assets/js/progress-bar.js?2f30e0e6801ea8f5036fa66e1ab0a71a" type="text/javascript"></script> <script src="/assets/js/vanilla-back-to-top.min.js?f40d453793ff4f64e238e420181a1d17"></script> <script>
    addBackToTop();
  </script> <script type="module" src="/assets/js/search/ninja-keys.min.js?a3446f084dcaecc5f75aa1757d087dcf"></script> <ninja-keys hidebreadcrumbs noautoloadmdicons placeholder="Type to start searching"></ninja-keys> <script src="/assets/js/search-setup.js?6c304f7b1992d4b60f7a07956e52f04a"></script> <script src="/assets/js/search-data.js"></script> <script src="/assets/js/shortcut-key.js?6f508d74becd347268a7f822bca7309d"></script> </body> </html>